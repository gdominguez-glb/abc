<% content_for :page_title do %>
  <%= Spree.t(:new_product_key) %>
<% end %>

<%= form_for @admin_new_coupon_code_form, url: spree.admin_coupon_codes_path, as: :coupon_code do |f| %>
  <fieldset>
    <div class="row">
      <div class="col-md-10">
        <div class="form-group">
          <label>Key</label>
          <%= f.text_field :code, class: 'form-control', placeholder: 'Leave this field blank for auto generated' %>
        </div>
        <div class="form-group">
          <label>Admin Email</label>
          <%= f.text_field :admin_email, class: 'form-control' %>
        </div>
        <div class="form-group">
          <label>School/District</label>
          <%= f.text_field :school_district_id, class: 'form-control' %>
        </div>
        <div class="form-group">
          <label>Upload list of schools</label>
          <%= f.file_field :schools_xls %>
          <%= f.hidden_field :school_lists %>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div data-hook="admin_licensed_product_form_product_id" class="form-group">
              <label>Select Product</label>
              <%= select_tag :product_id, options_from_collection_for_select(Spree::Product.order(:name), :id, :internal_name), prompt: 'Select Product', class: 'form-control'  %>
            </div>
          </div>
          <div class="col-md-2">
            <div data-hook="admin_licensed_product_form_quantity" class="form-group">
              <label>Quanity</label>
              <%= text_field_tag :quantity, nil, class: 'form-control' %>
            </div>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary" style="margin-top: 26px;" id="add-product-btn">Add Product</button>
          </div>
        </div>

        <div class="row" id="products-container" style="padding-left: 20px;">
          <p>
            Products:
          </p>
          <% (params[:products] || {}).each do |product_id, quantity| %>
            <% product = Spree::Product.find(product_id) %>
            <div class='product-item'>
              <span><%= product.name %></span>/<%= quantity %><input type='hidden' name='products[<%= product_id %>]' value='<%= quantity %>'><button class='btn btn-default remove-product'>Remove</button>
            </div>
          <% end %>
        </div>

        <div class="form-group">
          <label>Total Quantity</label>
          <%= f.text_field :total_quantity, class: 'form-control' %>
        </div>
        <div class="form-group">
          <label>Would you like to sync the assets to an existing order?</label>
          <%= f.select :sync_specified_order, [['Yes', 1], ['No', 0]], { prompt: 'Choose Option' }, class: 'form-control' %>
        </div>
        <div class="form-group hide" id="sf_order_id_field">
          <label>SF Order ID (sync assets to the specify order, Optional)</label>
          <%= f.text_field :sf_order_id, class: 'form-control' %>
        </div>
        <div class="form-group">
          <label>Amount</label>
          <%= f.text_field :amount, class: 'form-control' %>
        </div>
        <div class="form-group">
          <label>Payment Method</label>
          <%= f.collection_select :payment_method_id, @payment_methods, :id, :name, { include_blank: 'Select Payment Method' }, class: 'form-control' %>
        </div>

        <ul class="nav" id="payment-methods" data-hook>
          <% @payment_methods.each do |method| %>
            <li id="payment_method_<%= method.id %>" class="payment-method" style="display: none;">
              <fieldset>
                <%= render :partial => "spree/checkout/payment/#{method.method_type}", :locals => { :payment_method => method } %>
              </fieldset>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
    <div class="form-actions" data-hook="buttons">
      <%= button Spree.t(:create), 'save' %>
    </div>
  </fieldset>
<% end %>

<script type="text/javascript">
  $(function(){

     $("#coupon_code_school_district_id").select2({
        placeholder: "Select school/district",
        multiple: false,
        ajax: {
          url: '/store/admin/school_districts',
          datatype: 'json',
          data: function (term, page) {
            return {
              per_page: 50,
              page: page,
              without_children: true,
              q: term,
              token: Spree.api_key
            };
          },
          results: function (data, page) {
            var more = page < data.pages;
            return {
              results: data['school_districts'],
              more: more
            };
          }
        },
        formatResult: function (product) {
          return product.name;
        },
        formatSelection: function (product) {
          return product.name;
        }
     });

    $('#coupon_code_sync_specified_order').change(function(){
      if($(this).val() == '1') {
        $('#sf_order_id_field').removeClass('hide');
      } else {
        $('#sf_order_id_field').addClass('hide');
      }
    });


    $('#coupon_code_payment_method_id').change(function(){
      var paymentMethodId = $(this).val();
      togglePaymentMethod(paymentMethodId);
    });

    function togglePaymentMethod(paymentMethodId) {
      $('.payment-method').hide();
      $('#payment-methods :input').prop('disabled', true);
      $("#payment_method_" + paymentMethodId).show();
      $("#payment_method_" + paymentMethodId + ' :input').prop('disabled', false);
    }

    togglePaymentMethod($('#coupon_code_payment_method_id').val());

    $('#product_id').select2();

    var productHTML = "<div class='product-item'><span>PRODUCT_NAME</span>/QUANTITY<input type='hidden' name='products[PRODUCT_ID]' value='QUANTITY'><button class='btn btn-default remove-product'>Remove</button></div>";
    $('#add-product-btn').click(function(e){
      e.preventDefault();
      var html = productHTML;
      var productId = $('#product_id').val();
      var productName = $('#product_id option:selected').text();
      var quantity = $('#quantity').val();
      if (!productId || !quantity) {
        alert('Please choose product and enter quantity!');
        return;
      }
      html = html.replace('PRODUCT_NAME', productName);
      html = html.replace(/QUANTITY/g, quantity);
      html = html.replace('PRODUCT_ID', productId);
      $('#products-container').append(html);
      $('#product_id').select2('val', null);
      $('#quantity').val('');
    });

    $(document).on('click', '.remove-product', function(e){
      $(this).closest('.product-item').remove();
    });

    $(".cardNumber").payment('formatCardNumber');
    $(".cardExpiry").payment('formatCardExpiry');
    $(".cardCode").payment('formatCardCVC');

    $(".cardNumber").change(function(){
      $(this).parent().siblings(".ccType").val($.payment.cardType($(this).val()));
    });
  });
</script>
