var emails = <%= raw @emails.to_json %>;

// Hide the modal
$('#select-users-modal').modal('hide');

$('body').append("<%= escape_javascript(render 'confirm_users_modal') %>");
$('#confirm-add-users-modal').modal('show');
$('#confirm-add-users-modal').on('hidden.bs.modal', function (e) {
  $('#confirm-add-users-modal').remove();
});

$('#confirm-add-users-btn').click(function(){
  <% unless params[:file].blank? %>
    // limit quantity to 1 per user
    $('input[name="assign_licenses_form[licenses_number]"]').val(1);
    $('input[name="assign_licenses_form[licenses_number]"]').attr('readonly', true);
  <% end %>

  // Get emails from hidden license recipients input
  $('#assign_licenses_form_licenses_recipients').val(emails.join(','));

  $('#confirm-add-users-modal').modal('hide');

  if (emails.length > 0) {
    // Reveal the checkbox in step 2
    $('.js-step-2 .js-check-icon').removeClass('hide');

    // Update the button text in step 2
    $('#show-add-users-modal-btn').text('Edit Users');

    // Show the success message
    $('.js-step-2 .js-success-message').removeClass('hide');
    $('.js-step-2 .js-number-total').text(emails.length);
    if (emails.length > 1) {
      $('.js-step-2 .js-success-message').append('s');
    }

    // Add the email total to the "Number of Users" box in step 3
    $('#assign_licenses_form_total').val(emails.length);

    // Get the total quantity from the input in step 3
    var licenseCount = $('#assign_licenses_form_licenses_number').val();

    // Update the total license count in step 3
    $('#licenseTotal').text(emails.length * licenseCount);

    window.validateSubmitButton();

    // Make the "Number of Users" box in step 3 green
    $('#assign_licenses_form_total').addClass('success');

    // Reveal the checkbox in step 3
    $('.js-step-3 .js-check-icon').removeClass('hide');
  } else {
    // Reset everything if there are no selected emails
    $('.js-step-2 .js-check-icon').addClass('hide');
    $('#show-add-users-modal-btn').text('Add Users');
    $('.js-step-2 .js-success-message').addClass('hide');
    $('#assign_licenses_form_total').val('0');
    $('#licenseTotal').text('');
    $('#btnAssignLicenses').addClass('disabled');
    $('#assign_licenses_form_total').removeClass('success');
    $('.js-step-3 .js-check-icon').addClass('hide');
  }
});
